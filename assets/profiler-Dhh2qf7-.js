import{R as x,s as J,a as Q}from"./privacyConstants-201sPjeh.js";import{I as W,z as Y,M as Z}from"./bufferedData-Bfc_pTqn.js";import{az as O,o as $,aa as ee,b as k,a as M,ag as te,F as I,r as ne,s as se,c as re,e as oe,a4 as ae,_ as ie}from"./resourceUtils-CpcWtzjX.js";function le(e,t,o,a){const f=d=>{t.notify(14,{error:d}),Y("Error reported to customer",{"error.message":d.message})},l=W([e.profilingEndpointBuilder],f),p=o(a);return{async send({event:d,...g}){const v=new FormData,s=O(d);if(!s)throw new Error("Failed to serialize event");v.append("event",new Blob([s],{type:"application/json"}),"event.json");let w=s.length;for(const[T,E]of $(g)){const m=O(E);if(!m)throw new Error("Failed to serialize attachment");const h=await ce(p,m);w+=h.outputBytesCount,v.append(T,new Blob([h.output]),T)}l.send({data:v,bytesCount:w})}}}function ce(e,t){return new Promise(o=>{e.write(t),e.finish(a=>{o(a)})})}function ue(e){let t=0;for(const o of e)o.stackId!==void 0&&t++;return t}const y=new Map;function de(e,t){y.set(t,e)}function fe(e){return y.get(e)}function R(e){for(const t of y.keys())t<e&&y.delete(t)}function me({rawRumEvent:e,startTime:t}){if(e.type!==x.LONG_TASK)return;const o=e.long_task.id;de(o,t)}const pe=/\/(?![vV]\d{1,2}\/)([^/\d?]*\d+[^/?]*)/g;function ve(e){return e?e.replace(pe,"/?"):"/"}const A=(e,t)=>e||ve(t);function be(e,t,o){const a={application:{id:t}};o&&(a.session={id:o});const{ids:f,names:l}=ge(e.views);f.length&&(a.view={id:f,name:l});const p=e.longTasks.map(d=>d.id).filter(d=>d!==void 0);return p.length&&(a.long_task={id:p}),a}function ge(e){const t={ids:[],names:[]};for(const o of e)t.ids.push(o.viewId),o.viewName&&t.names.push(o.viewName);return t.names=Array.from(new Set(t.names)),t}function he(e,t,o){return{event:we(e,t,o),"wall-time.json":e}}function we(e,t,o){const a=Z(t),f=be(e,t.applicationId,o),l=Te(a);return{...f,attachments:["wall-time.json"],start:new Date(e.startClocks.timeStamp).toISOString(),end:new Date(e.endClocks.timeStamp).toISOString(),family:"chrome",runtime:"chrome",format:"json",version:4,tags_profiler:l.join(","),_dd:{clock_drift:ee()}}}function Te(e){return e.concat(["language:javascript","runtime:chrome","family:chrome","host:browser"])}const ke={sampleIntervalMs:10,collectIntervalMs:6e4,minProfileDurationMs:5e3,minNumberOfSamples:50};function Pe(e,t,o,a,f,l=ke){const p=le(e,t,f,6),d=J(Q.LONG_ANIMATION_FRAME);let g;const v=[];let s={state:"stopped"};function w(n){s.state!=="running"&&(g=n?{startClocks:n.startClocks,viewId:n.id,viewName:A(n.name,document.location.pathname)}:void 0,v.push(M(e,window,"visibilitychange",B).stop,M(e,window,"beforeunload",C).stop),m())}async function T(){await P("stopped"),v.forEach(n=>n()),R(k().relative),a.set({status:"stopped",error_reason:void 0})}function E(n){if(n.state==="running")return{cleanupTasks:n.cleanupTasks,observer:n.observer};const r=[];let i;if(e.trackLongTasks){i=new PerformanceObserver(F),i.observe({entryTypes:[V()]});const u=t.subscribe(12,b=>{me(b)});r.push(()=>i==null?void 0:i.disconnect()),r.push(u.unsubscribe)}const c=t.subscribe(2,u=>{const b={viewId:u.id,viewName:A(u.name,document.location.pathname),startClocks:u.startClocks};S(b),g=b});return r.push(c.unsubscribe),{cleanupTasks:r,observer:i}}function m(){const n=te().Profiler;if(!n)throw a.set({status:"error",error_reason:"not-supported-by-browser"}),new Error("RUM Profiler is not supported in this browser.");h(s).catch(I);const{cleanupTasks:r,observer:i}=E(s);let c;try{c=new n({sampleInterval:l.sampleIntervalMs,maxBufferSize:Math.round(l.collectIntervalMs*1.5/l.sampleIntervalMs)})}catch(u){u instanceof Error&&u.message.includes("disabled by Document Policy")?(ne.warn("[DD_RUM] Profiler startup failed. Ensure your server includes the `Document-Policy: js-profiling` response header when serving HTML pages.",u),a.set({status:"error",error_reason:"missing-document-policy-header"})):a.set({status:"error",error_reason:"unexpected-exception"});return}a.set({status:"running",error_reason:void 0}),s={state:"running",startClocks:k(),profiler:c,timeoutId:se(m,l.collectIntervalMs),longTasks:[],views:[],cleanupTasks:r,observer:i},S(g),c.addEventListener("samplebufferfull",_)}async function h(n){var r,i;if(n.state!=="running")return;L((i=(r=n.observer)===null||r===void 0?void 0:r.takeRecords())!==null&&i!==void 0?i:[]),re(n.timeoutId),n.profiler.removeEventListener("samplebufferfull",_);const{startClocks:c,longTasks:u,views:b}=n,H=k();await n.profiler.stop().then(N=>{const D=k(),q=u.length>0,K=oe(c.timeStamp,D.timeStamp)<l.minProfileDurationMs,X=ue(N.samples)<l.minNumberOfSamples;!q&&(K||X)||(j(Object.assign(N,{startClocks:c,endClocks:D,clocksOrigin:ae(),longTasks:u,views:b,sampleInterval:l.sampleIntervalMs})),R(H.relative))}).catch(I)}async function P(n){s.state==="running"&&(s.cleanupTasks.forEach(r=>r()),await h(s),s={state:n})}function S(n){s.state!=="running"||!n||s.views.push(n)}function j(n){var r;const i=(r=o.findTrackedSession())===null||r===void 0?void 0:r.id,c=he(n,e,i);p.send(c)}function _(){m()}function F(n){L(n.getEntries())}function L(n){if(s.state==="running")for(const r of n){if(r.duration<l.sampleIntervalMs)continue;const i=ie(r.startTime),c=fe(i.relative);s.longTasks.push({id:c,duration:r.duration,entryType:r.entryType,startClocks:i})}}function B(){document.visibilityState==="hidden"&&s.state==="running"?P("paused").catch(I):document.visibilityState==="visible"&&s.state==="paused"&&m()}function C(){m()}function V(){return d?"long-animation-frame":"longtask"}function z(){return s.state==="stopped"}function U(){return s.state==="running"}function G(){return s.state==="paused"}return{start:w,stop:T,isStopped:z,isRunning:U,isPaused:G}}export{ke as DEFAULT_RUM_PROFILER_CONFIGURATION,Pe as createRumProfiler};
//# sourceMappingURL=profiler-Dhh2qf7-.js.map
