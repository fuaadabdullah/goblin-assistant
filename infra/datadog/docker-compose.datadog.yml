# Datadog Agent as Sidecar Container
# Add this to your docker-compose.yml or Kubernetes deployment

version: '3.8'
services:
  goblin-assistant:
    # Your main app container
    image: goblin-assistant:latest
    environment:
      - DATADOG_API_KEY=${DATADOG_API_KEY}
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=goblin-assistant
      - DD_TAGS=env:${DD_ENV:-dev},service:goblin-assistant
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro  # For container monitoring
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
    networks:
      - datadog

  datadog-agent:
    image: datadog/agent:latest
    environment:
      - DD_API_KEY=${DATADOG_API_KEY}
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=goblin-assistant
      - DD_TAGS=env:${DD_ENV:-dev},service:goblin-assistant,deployment:docker
      - DD_LOGS_ENABLED=true
      - DD_APM_ENABLED=true
      - DD_PROCESS_AGENT_ENABLED=true
      - DD_DOGSTATSD_NON_LOCAL_TRAFFIC=true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
      - ./infra/datadog/datadog.yaml:/etc/datadog-agent/datadog.yaml:ro
    networks:
      - datadog
    ports:
      - "8126:8126"  # APM
      - "8125:8125/udp"  # DogStatsD

networks:
  datadog:
    driver: bridge

# For Kubernetes DaemonSet deployment, use:
# kubectl apply -f infra/datadog/datadog-k8s.yaml
